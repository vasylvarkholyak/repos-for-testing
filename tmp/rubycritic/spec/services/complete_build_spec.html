<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-03-27 20:38:48 -0700'>2018-03-27 20:38:48 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/services /</small> complete_build_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">206</span><small> lines of codes</small></div>
              <div><span class="metric">6</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">34.3</span><small> complexity/method</small></div>
              <div><span class="metric">19</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">206.07</span><small> complexity</small></div>
              <div><span class="metric">18</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                4
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &quot;rails_helper&quot;

describe CompleteBuild do
  describe &quot;.call&quot; do
    context &quot;when build has violations&quot; do
      context &quot;when the build is complete&quot; do
        it &quot;makes comments only for new violations and repects max limit&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.call)::context(when build has violations)::context(when the build is complete)::it#makes comments only for new violations and repects max limit has a flog score of 29</span>          </div>  </li></ol>
          stub_const(&quot;Hound::MAX_COMMENTS&quot;, 2)
          build = stub_build([&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;])
          existing_comment = build_comment(&quot;foo&quot;)
          pull_request = stub_pull_request([existing_comment])
          stubbed_github_api

          CompleteBuild.call(
            pull_request: pull_request,
            build: build,
            token: &quot;abc123&quot;,
          )

          expect(pull_request).to have_received(:make_comments) do |arg|
            expect(arg.flat_map(&amp;:messages)).to match_array [&quot;bar&quot;]
          end
        end

        context &quot;when fail on violations is disabled&quot; do
          it &quot;sets GitHub status to complete&quot; do
            stubbed_hound_config(fail_on_violations?: false)
            build = stub_build([&quot;foo&quot;])
            github_api = stubbed_github_api

            run_service(build)

            expect(github_api).to have_received(:create_success_status).with(
              build.repo_name,
              build.commit_sha,
              &quot;1 violation found.&quot;,
            )
          end
        end

        context &quot;when fail on violations is enabled&quot; do
          it &quot;sets GitHub status to failed&quot; do
            build = stub_build([&quot;foo&quot;])
            stubbed_hound_config(fail_on_violations?: true)
            github_api = stubbed_github_api

            run_service(build)

            expect(github_api).to have_received(:create_error_status).with(
              build.repo_name,
              build.commit_sha,
              &quot;1 violation found.&quot;,
              nil,
            )
          end
        end
      end

      context &quot;when the build is not complete&quot; do
        it &quot;does not comment and does not set success status&quot; do
          build = stub_build([&quot;foo&quot;], completed?: false)
          pull_request = stub_pull_request
          github_api = stubbed_github_api

          CompleteBuild.call(
            pull_request: pull_request,
            build: build,
            token: &quot;abc123&quot;,
          )

          expect(pull_request).not_to have_received(:make_comments)
          expect(github_api).not_to have_received(:create_success_status)
        end
      end
    end

    context &quot;when build does not have violations&quot; do
      it &quot;sets GitHub status to complete&quot; do
        build = stub_build([])
        stubbed_hound_config(fail_on_violations?: false)
        github_api = stubbed_github_api

        run_service(build)

        expect(github_api).to have_received(:create_success_status).with(
          build.repo_name,
          build.commit_sha,
          I18n.t(:complete_status, count: 0),
        )
      end

      it &quot;does not send a PR review&quot; do
        stub_const(&quot;Hound::MAX_COMMENTS&quot;, 2)
        build = stub_build([])
        pull_request = stub_pull_request([])
        stubbed_github_api

        CompleteBuild.call(
          pull_request: pull_request,
          build: build,
          token: &quot;abc123&quot;,
        )

        expect(pull_request).not_to have_received(:make_comments)
      end
    end

    context &quot;when build has file review errors&quot; do
      it &quot;adds a comment to pull request review&quot; do
        build = stub_build([], review_errors: [&quot;cannot parse config&quot;])
        pull_request = stub_pull_request
        stubbed_github_api

        CompleteBuild.call(
          pull_request: pull_request,
          build: build,
          token: &quot;abc123&quot;,
        )

        expect(pull_request).to have_received(:make_comments).
          with([], [&quot;cannot parse config&quot;])
      end
    end

    context &quot;with subscribed private repo and opened pull request&quot; do
      it &quot;tracks build events&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.call)::context(with subscribed private repo and opened pull request)::it#tracks build events has a flog score of 25</span>          </div>  </li></ol>
        repo = create(:repo, :active, github_id: 123, private: true)
        build = create(:build, repo: repo)
        create(:subscription, repo: repo)
        stubbed_github_api

        run_service(build)

        expect(analytics).to have_tracked(&quot;Build Completed&quot;).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="build_runner_spec.html#L131" class="js-smell-location">0</a>                  <a href="complete_build_spec.html#L134" class="js-smell-location">1</a>                  </div>  </li></ol>
          for_user(repo.subscription.user).
          with(properties: { name: repo.name, private: true })
      end
    end

    def stubbed_github_api
      github_api = instance_double(
        &quot;GitHubApi&quot;,
        create_success_status: nil,
        create_error_status: nil,
      )
      allow(GitHubApi).to receive(:new).and_return(github_api)

      github_api
    end

    def stubbed_hound_config(options = {})
      hound_config = instance_double(&quot;HoundConfig&quot;, options)
      allow(HoundConfig).to receive(:new).and_return(hound_config)

      hound_config
    end

    def stub_build(violation_messages, attributes = {})
      violations = violation_messages.map do |violation_message|
        instance_double(
          &quot;Violation&quot;,
          filename: &quot;app/anything.rb&quot;,
          patch_position: 1,
          messages: [violation_message],
        )
      end
      repo = instance_double(
        &quot;Repo&quot;,
        subscription: false,
        owner: MissingOwner.new,
      )
      default_attributes = {
        completed?: true,
        review_errors: [],
        repo: repo,
        repo_name: &quot;foo/bar&quot;,
        commit_sha: &quot;abc123&quot;,
        violations: violations,
        violations_count: violations.size,
      }
      instance_double(&quot;Build&quot;, default_attributes.merge(attributes))
    end

    def stub_pull_request(comments = [])
      head_commit = instance_double(&quot;Commit&quot;, file_content: &quot;&quot;)
      instance_double(
        &quot;PullRequest&quot;,
        head_commit: head_commit,
        comments: comments,
        make_comments: nil,
      )
    end

    def build_comment(body)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>build_comment doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      OpenStruct.new(path: &quot;app/anything.rb&quot;, position: 1, body: body)
    end

    def run_service(build)
      CompleteBuild.call(
        pull_request: stub_pull_request,
        build: build,
        token: &quot;abc123&quot;,
      )
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
